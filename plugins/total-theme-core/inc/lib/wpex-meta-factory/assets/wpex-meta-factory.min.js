window.wpexMetaFactory=window.wpexMetaFactory||{},function(e,t,n){"use strict";e(document).ready(function(){t.init()}),t.init=function(){var e=t.metabox();t.fieldColorPicker(e),t.fieldSelectIcon(e),e.on("keydown",t.handleKeydown),e.on("change",'input[type="text"]',t.handleUploadChange),e.on("click",".wpex-mf-upload",t.handleUploadClick),e.on("click",".wpex-mf-clone-group",t.cloneGroup),e.on("click",".wpex-mf-remove-group",t.removeGroup)},t.metabox=function(){return t.$metabox?t.$metabox:(t.$metabox=e(".wpex-mf-metabox"),t.$metabox)},t.fieldColorPicker=function(t){"function"==typeof e.fn.wpColorPicker&&e(".wpex-mf-colorpicker",t).wpColorPicker()},t.fieldSelectIcon=function(t){t.on("click",".wpex-mf-icon-select-wrap button",function(t){t.preventDefault();var n=e(this).parent(".wpex-mf-icon-select-wrap").find(".wpex-mf-icon-select-modal");n.addClass("wpex-mf-active"),n.find(".wpex-mf-icon-select-search").focus()}),t.on("click",".wpex-mf-icon-select-modal-choices a",function(t){t.preventDefault();var n=e(this),o=n.closest(".wpex-mf-icon-select-wrap"),i=n.attr("data-value");i=0==i?"":i,o.find('input[type="text"]').val(i),n.closest(".wpex-mf-icon-select-modal").removeClass("wpex-mf-active"),n.closest(".wpex-mf-icon-select-wrap").find(".wpex-mf-icon-select-preview > span").attr("class",i)}),t.on("click",".wpex-mf-icon-select-modal button.wpex-mf-close",function(t){t.preventDefault(),e(this).closest(".wpex-mf-icon-select-modal").removeClass("wpex-mf-active")}),e(".wpex-mf-icon-select-search").on("keyup",function(){var t=e(this),n=t.val().toLowerCase();t.next().find("a").filter(function(){e(this).toggle(e(this).attr("data-value").toLowerCase().indexOf(n)>-1)})}),e('.wpex-mf-icon-select-wrap > input[type="text"]').on("keyup",function(){var t=e(this),n=t.val().toLowerCase();t.closest(".wpex-mf-icon-select-wrap").find(".wpex-mf-icon-select-preview > span").attr("class",n)})},t.handleKeydown=function(t){if(27==event.keyCode){var n=e(".wpex-mf-icon-select-modal");n.hasClass("wpex-mf-active")&&n.removeClass("wpex-mf-active")}},t.handleUploadChange=function(t){var n=e(this).closest("td").find(".wpex-mf-upload-preview__content");n.length&&!e(this).val()&&n.empty()},t.handleUploadClick=function(n){n.preventDefault();var o=e(this).closest("td").find('input[type="text"]');t.fieldUpload(o)},t.fieldUpload=function(e){var n;if(wp)if(void 0===n){n=wp.media.frames.file_frame=wp.media({id:"wpex-mf-metabox-upload",frame:"post",state:"insert",filterable:"uploaded",multiple:!1,syncSelection:!1,autoSelect:!0});var o=e.closest("td").find(".wpex-mf-upload-preview");n.on("insert",function(){var i=n.state().get("selection").first().toJSON()[e.data("selection")];e.val(i),o.length&&t.fieldPreviewAJAX(o,i)}),n.open()}else n.open()},t.fieldPreviewAJAX=function(e,t){var o=e.find(".wpex-mf-upload-preview__content");o.empty();var i=e.find(".wpex-mf-upload-preview__loader");i.show();var a=new XMLHttpRequest,c="action=wpex_mf_field_preview_ajax&field_value="+t+"&nonce="+n.ajax_nonce;a.onload=function(){if(4==a.readyState&&200==a.status){var e=this.responseText;e&&o.html(e)}else console.log(this.responseText);i.hide()},a.open("POST",window.ajaxurl,!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),a.send(c)},t.cloneGroup=function(n){n.preventDefault();var o=e(this).prev(".wpex-mf-group-set"),i=o.find(".wpex-mf-group:last").clone("true");i.appendTo(o),t.resetFields(i),t.updateIndexes(o),t.setFocus(i)},t.resetFields=function(t){t.find("input, textarea").each(function(){e(this).val("")}),t.find("select").each(function(){e(this).val(e(this).find("option:first-child").val())})},t.updateIndexes=function(t){t.find(".wpex-mf-group").each(function(t){var n=e(this);n.find(".wpex-mf-group-set-index").text((t+1).toString()),n.find("label.wpex-mf-label").each(function(){var n=e(this);e(this).attr("for",n.attr("for").replace(/-(\d+)-/,"-"+t+"-"))}),n.find("input, select, textarea").each(function(){var n=e(this);n.attr("id",n.attr("id").replace(/-(\d+)-/,"-"+t+"-")),n.attr("name",n.attr("name").replace(/\[(\d+)\]/,"["+t+"]"))})})},t.removeGroup=function(o){if(o.preventDefault(),confirm(n.delete_group_confirm)){var i=e(this).closest(".wpex-mf-group"),a=parseInt(i.find(".wpex-mf-group-set-index").text()),c=e(this).closest(".wpex-mf-group-set");c.find(".wpex-mf-group").length>1?(i.remove(),t.updateIndexes(c,a)):t.resetFields(i)}},t.setFocus=function(e){e.find("select, input, textarea, button, a").filter(":visible").first().focus()}}(jQuery,window.wpexMetaFactory,wpexMetaFactoryL10n);